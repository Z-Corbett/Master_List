var scModalGallery=function(s,g,e,a){var c,t=s.devicePixelRatio||1,l=1<t?"?dpr="+t:"",i=function(e,a){this.options=a||{},this.container=e,this.$container=g(e),this.$gallery=this.$container.find(".galleryWrapper"),this.imgPrefix=this.$container.attr("data-img-server")+"/"+g("body").attr("data-site-id"),this.largeImgOpts="/1/"+this.$container.attr("data-large-img-opts")+l,this.$images=this.$gallery.find("img"),this.galleryCount=this.$images.length,this.preloadUrls=[],this.images=[],this.createModal(),this.prepImagePreload(),this.bindHandlers(),this.galleryInstanceId=this.$container.attr("data-gallery-instance")};return i.prototype={constructor:i,bindHandlers:function(){var o=this;this.$gallery.on("click","img",function(e){o.viewInModal(g(e.target).attr("data-gallery-index"))}),this.$gallery.on("click","a",function(e){g(e.currentTarget).closest(".imgCaption-credit").length||e.preventDefault()}),this.$gallery.on("keyup","img",function(e){13===(e.which||e.keyCode)&&o.viewInModal(g(e.target).attr("data-gallery-index"))}),this.$gallery.on("click",".customCaption",function(e){e.preventDefault(),e.stopPropagation(),g(e.currentTarget).parents("div").first().find("img").click()}),this.$gallery.on("afterAddItems",function(e){var r=o.$gallery.find("[data-gallery-index]").last().data("gallery-index")+1;o.$gallery.find("img:not([data-gallery-index])").each(function(e,a){var t=g(a),l=e+r,i=o.getLargeSrc(t.attr("src"));o.preloadUrls.push(i),t.attr("data-gallery-index",l),o.images.push({dom:t,largeSrc:i})}),o.preloadBatch()}),this.$gallery.on("afterInsertItem",function(e,a){o.$images=o.$gallery.find("img");var t=o.$images.eq(a),l=o.getLargeSrc(t.attr("src"));o.images.splice(a,0,{dom:t,largeSrc:l}),o.preloadUrls=[l],o.preloadBatch()}),this.$gallery.on("reordered",function(e,a,t){o.$images=o.$gallery.find("img"),o.images=function(e,a,t){if(t===a)return e;for(var l=e[a],i=t<a?-1:1,r=a;r!==t;r+=i)e[r]=e[r+i];return e[t]=l,e}(o.images,a,t)}),this.$gallery.on("removeImage",function(e,a){o.$images=o.$gallery.find("img"),o.galleryCount=o.$images.length;for(var t=0;t<=o.galleryCount;t++)o.images.splice(a,1)}),g(s).on("load",function(){o.preloadBatch()})},viewInModal:function(e){if(this.currentImg=e=parseInt(e,10),s.scModalGalleries.currentGalleryId=this.galleryInstanceId,s.scModalGalleries.modalShowing||(c=document.activeElement),this.images[e]&&"largeSrc"in this.images[e]){if(s.scModalGalleries.$img||(s.scModalGalleries.$img=g('<img class="contentImg">').appendTo(this.$modalImgWrapper)),s.scModalGalleries.$img.attr("src",this.images[e].largeSrc),s.scModalGalleries.$img.parent().is(".modalImgLink")&&s.scModalGalleries.$img.unwrap(),"url"in this.images[e]){var a=g('<a class="modalImgLink" href="'+this.images[e].url+'"></a>');"newWin"in this.images[e]&&a.attr("target","_blank").attr("rel","noopener noreferrer"),s.scModalGalleries.$img.wrap(a)}s.scModalGalleries.$modal.toggleClass("hideArrows",1===this.$images.length);var t=.9*g(s).height();this.options.topAndBottomGutterHeight&&(t=g(s).height()-2*this.options.topAndBottomGutterHeight),s.scModalGalleries.$img.css("max-height",t),s.scModalGalleries.$modal.show(),s.scModalGalleries.modalShowing=!0,g("body").trigger("scGalleryModalShown"),this.$container.trigger("photoViewed",[this.images[e].dom])}},getLargeSrc:function(e){var a,t=e.substring(e.lastIndexOf("/"),e.length),l=-1<e.indexOf("/i/e/")?"/i/e/":"/i/",i=e.split(l);return 2===i.length&&(a=i[1].substring(0,i[1].indexOf("/"))),a?this.imgPrefix+l+a+this.largeImgOpts+t:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z/C/HgAGgwJ/lK3Q6wAAAABJRU5ErkJggg=="},prepImagePreload:function(){var r=this;g.each(r.$images,function(e,a){var t=g(a),l=t.attr("src")||t.attr("data-src"),i=r.getLargeSrc(l);t.attr("data-gallery-index",e),r.images.push({dom:t,largeSrc:i}),t.closest("a").length&&(r.images[e].url=t.closest("a").attr("href"),"_blank"===t.closest("a").attr("target")&&(r.images[e].newWin=!0)),r.preloadUrls.push(i)})},preloadBatch:function(){g.each(this.preloadUrls,function(e,a){(new Image).src=a}),this.preloadUrls=[]},createModal:function(){if(s.scModalGalleries.$modal)this.$modal=s.scModalGalleries.$modal;else{s.scModalGalleries.$modal=this.$modal=g('<div class="publicModalContainer"><div class="publicModalMask"></div><div class="publicModalContent modalImageGallery"><div class="imageContainer"><a class="imgNav prevImg galleryArrow galleryArrow--prev" href="#">prev</a><a class="imgNav nextImg galleryArrow galleryArrow--next" href="#">next</a></div></div><a class="publicModalClose" href="#">close</a></div>').appendTo(g("body")).hide(),this.options.customModalClasses&&this.$modal.addClass(this.options.customModalClasses)}this.$modalImgWrapper=this.$modal.find(".imageContainer")}},g(function(){function t(){s.scModalGalleries.$modal.hide(),s.scModalGalleries.modalShowing=!1,g("body").trigger("scGalleryModalHidden"),c&&c.focus()}var l,i,r;s.scModalGalleries={},s.scModalGalleries.instances={},g(".hasModalGallery").each(function(e,a){g(a).attr("data-gallery-instance",e),s.scModalGalleries.instances[e]=new scModalGallery(a,g(a).data("modal-gallery-options"))}),g("body").on("keydown",function(e){var a=e.which||e.keyCode;s.scModalGalleries.modalShowing&&27===a&&(e.preventDefault(),e.stopPropagation(),t())}),g("body").on("keyup",function(e){var a=e.which||e.keyCode;s.scModalGalleries.modalShowing&&(32===a||38===a||40===a?(e.preventDefault(),e.stopPropagation()):37===a?(e.preventDefault(),g(".modalImageGallery .prevImg").trigger("click")):39===a&&(e.preventDefault(),g(".modalImageGallery .nextImg").trigger("click")))}),g("body").on("click",".modalImageGallery .imgNav",function(e){e.preventDefault(),e.stopPropagation();var a,t=g(e.target).hasClass("prevImg"),l=s.scModalGalleries.instances[s.scModalGalleries.currentGalleryId];a=t?l.currentImg-1<0?l.galleryCount-1:l.currentImg-1:l.currentImg+1>l.galleryCount-1?0:l.currentImg+1,l.viewInModal(a)}),g("body").on("click",".publicModalContent",function(e){if(s.scModalGalleries.modalShowing){var a=g(e.target);a.is(".imgNav")||a.is(".contentImg")||t()}}),g("body").on("click",".publicModalClose",function(e){e.preventDefault(),t()}),g("body").on("click",".modalImageGallery .imageContainer > .customCaption",function(e){e.preventDefault(),e.stopPropagation()}),g(s).on("resize orientationchange",function(e){s.scModalGalleries.modalShowing&&s.scModalGalleries.$img&&s.scModalGalleries.$img.css("max-height",.9*g(s).height())});function e(e){1===e.touches.length&&(l=e.touches[0].pageX,i=e.touches[0].pageY,this.addEventListener("touchmove",o,!1),this.addEventListener("touchend",n,!1))}function o(e){r=l-e.touches[0].pageX,Math.abs(r)<Math.abs(e.touches[0].pageY-i)||e.preventDefault()}function n(e){if(r&&50<Math.abs(r)){var a=0<r?".nextImg":".prevImg";s.scModalGalleries.$modal.find(a).trigger("click"),e.preventDefault(),e.stopPropagation()}this.removeEventListener("touchmove",o,!1),this.removeEventListener("touchend",n,!1),r=i=l=null}"ontouchstart"in document.documentElement&&g(".publicModalContainer").each(function(){"ontouchstart"in document.documentElement&&this.addEventListener("touchstart",e,!1)})}),i}(window,jQuery,Modernizr);